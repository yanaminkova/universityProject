## SAP Cloud for Utilities Foundation Retailer MTA configuration for development deployment
# Verify with mbt mtad-gen -e ./sapedom.edom-retailer-dev.mtaext
_schema-version: '3.1'
extends: com.sap.c4u.foundation.retailer.core
ID: com.sap.c4u.foundation.retailer.core.dev
parameters:
    broker-credentials: '<%= brokerCredentials %>'
    displayName: SAP Cloud for Utilities Foundation Retailer Development
modules:
    - name: c4u-foundation-retailer-srv
      requires:
          - name: c4u-foundation-retailer-autoscaler
            parameters:
                config:
                    instance_min_count: 1
                    instance_max_count: 2
                    scaling_rules:
                        - metric_type: memoryutil
                          threshold: 90
                          operator: '>='
                          cool_down_secs: 300
                          adjustment: '+1'
                        - metric_type: memoryutil
                          threshold: 60
                          operator: '<'
                          cool_down_secs: 300
                          adjustment: '-1'
                        - metric_type: cpu
                          threshold: 90
                          operator: '>='
                          cool_down_secs: 300
                          adjustment: '+1'
                        - metric_type: cpu
                          threshold: 60
                          operator: '<'
                          cool_down_secs: 300
                          adjustment: '-1'
    - name: c4u-foundation-retailer-broker
      requires:
          - name: srv-binding
            properties:
                SBF_CATALOG_FILE: catalog-dev.json
                SBF_SERVICE_CONFIG:
                    c4u-foundation-retailer-dev-api:
                        extend_credentials:
                            per_plan:
                                standard:
                                    endpoints:
                                        v1: ~{srv-url}/api/v1
resources:
    - name: c4u-foundation-retailer-drm
      parameters:
          config:
              retention-configs:
                  dataSubjects:
                      - dataSubjectRole: BusinessPartner
                        dataSubjectDescription: 'BusinessPartner'
                        dataSubjectDescriptionKey: BusinessPartner
                        dataSubjectBaseURL: ~{srv-binding/srv-url}
                        dataSubjectInformationEndPoint: '/api/v1/dpp/drm/dataSubjectInformation'
                        dataSubjectDeletionEndPoint: '/api/v1/dpp/drm/dataSubjectDeletion'
                        dataSubjectsDestroyingEndPoint: '/api/v1/dpp/drm/dataSubjectsDestroying'
                        legalEntity:
                            legalEntity: 'SAP SE'
                            legalEntityDescription: 'Leading Cloud ERP company'
                            legalEntityValueHelpEndPoint: '/api/v1/dpp/legalEntities'
                        legalGrounds:
                            - legalGround: CustomerOrder
                              legalGroundDescription: 'Customer Order'
                              legalGroundBaseURL: ~{srv-binding/srv-url}
                              dataSubjectEndofBusinessEndPoint: '/api/v1/dpp/drm/dataSubjectEndofBusiness'
                              dataSubjectsEndofResidenceEndPoint: '/api/v1/dpp/drm/dataSubjectsEndofResidence'
                              dataSubjectsEndofResidenceConfirmationEndPoint: '/api/v1/dpp/drm/dataSubjectsEndofResidenceConfirmation'
                              dataSubjectLegalEntitiesEndPoint: '/api/v1/dpp/drm/dataSubjectLegalEntities'
                              dataSubjectLastRetentionStartDatesEndPoint: '/api/v1/dpp/drm/dataSubjectLastRetentionStartDates'
                              dataSubjectLegalGroundDeletionEndPoint: '/api/v1/dpp/drm/dataSubjectLegalGroundDeletion'
                              dataSubjectsLegalGroundDestroyingEndPoint: '/api/v1/dpp/drm/dataSubjectsLegalGroundDestroying'
                              startTimes:
                                  - startTime: endOfBusinessDate
                                    startTimeDescription: 'Timestamp on which the CustomerOrder has been closed'

    - name: c4u-foundation-retailer-xsuaa
      parameters:
          service-name: c4u-foundation-retailer-xsuaa
          service: xsuaa
          service-plan: broker
          config:
              xsappname: ${xsappname}
              tenant-mode: shared
              scopes:
                  - name: $XSAPPNAME.Admin
                    description: SAP Cloud for Utilities Foundation Retailer Admin
                  - name: $XSAPPNAME.UI.Edit
                    description: SAP Cloud for Utilities Foundation Retailer UI Edit Access
                  - name: $XSAPPNAME.UI.Browse
                    description: SAP Cloud for Utilities Foundation Retailer UI Browse Access
                  - name: $XSAPPNAME.API.Write
                    description: SAP Cloud for Utilities Foundation Retailer API Write Access
                  - name: $XSAPPNAME.API.Read
                    description: SAP Cloud for Utilities Foundation Retailer API Read Access
                  - name: $XSAPPNAME.API.Delete
                    description: SAP Cloud for Utilities Foundation Retailer API Delete Access
                  - name: $XSAPPNAME.DPPBlocked.Read
                    description: SAP Cloud for Utilities Foundation Retailer Data Privacy and Protection Blocked Read Access
                  - name: $XSAPPNAME.ExtendCDS
                    description: Extend tenant
                  - name: $XSAPPNAME.ExtendCDSdelete
                    description: Extend tenant allowing undeploy option
                  - name: $XSAPPNAME.MasterData.Sync
                    description: SAP Master Data Integration user
                  # Personal Data Manager
                  - name: $XSAPPNAME.PersonalDataManagerUser
                    description: Authority for Personal Data Manager
                    grant-as-authority-to-apps:
                        - $XSSERVICENAME(${pdm-service-name})
                  # Data Retention Manager
                  - name: $XSAPPNAME.DataRetentionManagerUser
                    description: Authority for Data Retention Manager
                    grant-as-authority-to-apps:
                        - $XSSERVICENAME(${drm-service-name})
                  # Tenant Onboarding/Offboarding
                  - name: $XSAPPNAME.mtcallback
                    description: SAP Cloud for Utilities Foundation Retailer tenant onboarding/offboarding
                    grant-as-authority-to-apps:
                        - $XSAPPNAME(application,sap-provisioning,tenant-onboarding)
                  # Tenant Re-deployment
                  - name: $XSAPPNAME.mtdeployment
                    description: SAP Cloud for Utilities Foundation Retailer tenant re-deployment
                  # Event Mesh
                  - name: $XSAPPNAME.emcallback
                    description: Event Mesh Callback Access
                    grant-as-authority-to-apps:
                        - $XSSERVICENAME(c4u-foundation-retailer-em)
                  # FLP
                  - name: uaa.user
                    description: UAA
                  # Job Scheduling
                  - name: $XSAPPNAME.jobcallback
                    description: Job Scheduling Callback Access
                    grant-as-authority-to-apps:
                        - $XSSERVICENAME(c4u-foundation-retailer-job)
              authorities:
                  - $XSAPPNAME.API.Read
                  - $XSAPPNAME.API.Write
                  - $XSAPPNAME.API.Delete
                  - $XSAPPNAME.mtdeployment
              role-templates:
                  - name: RetailerAdmin
                    description: SAP Cloud for Utilities Foundation Retailer Admin
                    scope-references:
                        - $XSAPPNAME.Admin
                        - $XSAPPNAME.API.Write
                        - $XSAPPNAME.API.Read
                        - $XSAPPNAME.API.Delete
                        - $XSAPPNAME.UI.Edit
                        - $XSAPPNAME.UI.Browse
                        - $XSAPPNAME.DPPBlocked.Read
                        - $XSAPPNAME.MasterData.Sync
                  - name: RetailerUser
                    description: SAP Cloud for Utilities Foundation Retailer User
                    scope-references:
                        - $XSAPPNAME.API.Write
                        - $XSAPPNAME.API.Read
                        - $XSAPPNAME.API.Delete
                        - $XSAPPNAME.UI.Edit
                        - $XSAPPNAME.UI.Browse
                  - name: RetailerViewer
                    description: SAP Cloud for Utilities Foundation Retailer Viewer
                    scope-references:
                        - $XSAPPNAME.API.Read
                        - $XSAPPNAME.UI.Browse
                  - name: ExtensionDeveloper
                    description: SAP Cloud for Utilities Foundation Retailer CDS Extension Developer
                    scope-references:
                        - $XSAPPNAME.ExtendCDS
                        - uaa.user
                  - name: ExtensionDeveloperUndeploy
                    description: SAP Cloud for Utilities Foundation Retailer CDS Extension Developer with undeploy rights
                    scope-references:
                        - $XSAPPNAME.ExtendCDSdelete
                        - $XSAPPNAME.ExtendCDS
                        - uaa.user
